<!-- General renderer. -->
<ng-template #renderer>
    @if (!separator) {
        <div
            class="fd-navigation__item"
            [class.fd-navigation__item--group]="isGroup$()"
            [class.fd-navigation__item--create]="quickCreate$()"
            [class.fd-navigation__item--child]="normalizedLevel$() > 2"
            [class.fd-navigation__item--overflow]="isOverflow$()"
            [class.fd-navigation__item--with-expander]="!!link$()?.routerLink && hasChildren$()"
            [class.fd-navigation__item--disabled]="disabled$()"
            [attr.id]="id()"
            [attr.role]="roleAttr$()"
            [attr.aria-level]="ariaLevelAttr$()"
            [attr.aria-label]="ariaLabelAttr$()"
            [attr.aria-selected]="ariaSelectedAttr$()"
            [attr.aria-checked]="ariaCheckedAttr$()"
            [attr.aria-expanded]="expandedAttr$()"
            [attr.aria-disabled]="disabled$()"
            [attr.aria-owns]="ariaOwnsAttr$()"
            [attr.aria-haspopup]="ariaHasPopupAttr$()"
            [attr.aria-current]="ariaCurrentAttr$()"
            [attr.normalized-level]="normalizedLevel$()"
            (focusin)="_focusInHandler()"
            (click)="handleItemClick()"
            (keydown)="handleItemKeydown($event)"
            fdbNavigationListItemMarker
            #itemContainer
        >
            @if (!navigation.isSnapped$() || !hasChildren$()) {
                <ng-template
                    [ngTemplateOutlet]="linkRenderer"
                    [ngTemplateOutletContext]="{ $implicit: true }"
                ></ng-template>
            } @else {
                <ng-template
                    [ngTemplateOutlet]="snappedNavigationItemRenderer"
                    [ngTemplateOutletContext]="{ $implicit: itemContainer }"
                ></ng-template>
            }
        </div>
        @if (isOverflow$() && hasChildren$()) {
            <ng-template [ngTemplateOutlet]="overflowItemListRenderer"></ng-template>
        }
        @if (!navigation.isSnapped$()) {
            <ng-template [ngTemplateOutlet]="listRenderer"></ng-template>
        }
    }
</ng-template>
<!-- Snapped navigation list item renderer. Implicit context points to the popover trigger element. -->
<ng-template #snappedNavigationItemRenderer let-itemContainer>
    <ng-template [ngTemplateOutlet]="linkRenderer" [ngTemplateOutletContext]="{ $implicit: false }"></ng-template>
    @if (!isOverflow$()) {
        <fd-popover
            #popover
            [noArrow]="true"
            additionalBodyClass="fd-navigation__list-container"
            [isOpen]="popoverOpen$()"
            (isOpenChange)="_onPopoverOpen($event, popover)"
            [trigger]="itemContainer"
            [focusAutoCapture]="true"
            [restoreFocusOnClose]="false"
            [focusTrapped]="true"
            [placement]="popoverPlacement()"
            [disableScrollbar]="true"
        >
            <fd-popover-body [ngClass]="navigation.classList$()">
                <ng-template
                    [ngTemplateOutlet]="wrapperRenderer"
                    [ngTemplateOutletContext]="{ $implicit: true }"
                ></ng-template>
            </fd-popover-body>
        </fd-popover>
    }
</ng-template>
<!-- Generic link renderer. -->
<ng-template #linkRenderer let-showToggleButton>
    <ng-template [ngTemplateOutlet]="linkRef?.templateRef || null"></ng-template>
    @if (!!link$()?.routerLink && hasChildren$()) {
        <span
            class="fd-navigation__has-children-indicator"
            role="button"
            [attr.aria-label]="expanderAriaLabelAttr$()"
            (click)="toggleExpanded()"
        ></span>
    }
</ng-template>
<!-- Generic list renderer. Used when navigation is not snapped. -->
<ng-template #listRenderer>
    @if (isGroup$() && normalizedLevel$() === 1) {
        <ul
            fdb-navigation-list
            [listItems]="listItems$()"
            parentItems
            [moreButtonRef]="_moreButtonRef$()"
            [attr.id]="id() + '-list'"
        ></ul>
    } @else if (hasChildren$()) {
        <div class="fd-navigation__list-container">
            <ng-template
                [ngTemplateOutlet]="wrapperRenderer"
                [ngTemplateOutletContext]="{ $implicit: false }"
            ></ng-template>
        </div>
    }
</ng-template>
<!-- Template used for rendering sublist of items for the list item that is currently in overflow menu. -->
<ng-template #overflowItemListRenderer>
    <div class="fd-navigation__list-container fd-navigation__list-container--submenu fd-menu__sublist">
        <ng-template [ngTemplateOutlet]="wrapperRenderer" [ngTemplateOutletContext]="{ $implicit: true }"></ng-template>
    </div>
</ng-template>
<!-- Generic list renderer. Implicit context defines whether the inner list should handle keyboard navigation by its own. -->
<ng-template #wrapperRenderer let-keyboardNavigation>
    <div
        class="fd-navigation__list-wrapper"
        [attr.role]="wrapperRoleAttr$()"
        [attr.aria-roledescription]="wrapperAriaRoleDescriptionAttr$()"
    >
        @if (navigation.isSnapped$() && !isOverflow$()) {
            <!-- If opener link itself is active, project aria-checked attribute to link repeater too for snapped mode. -->
            <div
                class="fd-navigation__item fd-navigation__item--title fd-navigation__item--child"
                [attr.role]="titleItemRoleAttr$()"
                [attr.aria-selected]="titleItemAriaSelectedAttr$()"
                [attr.tabindex]="titleItemFocusable$() ? 0 : -1"
            >
                <ng-template
                    [ngTemplateOutlet]="linkRenderer"
                    [ngTemplateOutletContext]="{ $implicit: false }"
                ></ng-template>
            </div>
        }
        <ul
            fdb-navigation-list
            [listItems]="listItems$() || []"
            [childItems]="true"
            [role]="isOverflow$() ? 'menu' : 'group'"
            (keydown)="(false)"
            (focusBefore)="_focusBeforeList()"
            [withKeyboardNavigation]="keyboardNavigation"
            [moreButtonRef]="_moreButtonRef$()"
            [attr.id]="childListIdAttr$()"
        ></ul>
    </div>
</ng-template>
