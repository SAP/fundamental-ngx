<ng-template [ngTemplateOutlet]="mobile ? mobileTemplate : desktopTemplate"></ng-template>
<ng-template #desktopTemplate>
    <fd-popover
        [isOpen]="_isOpen$()"
        (isOpenChange)="_isOpen$.set($event)"
        [triggers]="[]"
        fillControlMode="equal"
        [focusTrapped]="true"
    >
        <fd-popover-control>
            <ng-template [ngTemplateOutlet]="inputFieldTemplate"></ng-template>
        </fd-popover-control>
        <fd-popover-body
            (keydown)="_handlePopoverKeydown($event)"
            [style.display]="
                (_dropdownValues$ | async | suggestionMatches: inputText).length > 0 ||
                initialSuggestionTitle() ||
                suggestionFooter() ||
                searchResultsEmptyTemplate()
                    ? 'inherit'
                    : 'none'
            "
        >
            <fd-busy-indicator
                [block]="true"
                [loading]="suggestionsLoading()"
                [title]="busyIndicatorTitle()"
                [ariaValueText]="busyIndicatorAriaValueText()"
            >
                @if (
                    initialSuggestionTitle()!.length > 0 &&
                    (_dropdownValues$ | async | suggestionMatches: inputText).length > 0
                ) {
                    <div fd-popover-body-header>
                        <div
                            fd-bar
                            [initialSuggestionTitle]="true"
                            [barDesign]="initialSuggestionSubline() ? 'header-with-subheader' : 'header'"
                        >
                            <div fd-bar-left>
                                <span fd-title [twoLineClamp]="true" [headerSize]="6">
                                    {{ initialSuggestionTitle() }}
                                </span>
                            </div>
                        </div>
                        @if (initialSuggestionSubline()) {
                            <div fd-bar [initialSuggestionSubline]="true" barDesign="subheader">
                                <div fd-bar-left>
                                    <fd-text [subline]="true" [text]="initialSuggestionSubline()"></fd-text>
                                </div>
                            </div>
                        }
                    </div>
                } @else if (
                    initialSuggestionEmptyTitle()!.length > 0 &&
                    (_dropdownValues$ | async | suggestionMatches: inputText).length === 0
                ) {
                    <div fd-popover-body-header>
                        <div
                            fd-bar
                            [initialSuggestionTitle]="true"
                            [barDesign]="initialSuggestionEmptySubline() ? 'header-with-subheader' : 'header'"
                        >
                            <div fd-bar-left>
                                <span fd-title [twoLineClamp]="true" [headerSize]="6">
                                    {{ initialSuggestionEmptyTitle() }}
                                </span>
                            </div>
                        </div>
                        @if (initialSuggestionEmptySubline()) {
                            <div fd-bar [initialSuggestionSubline]="true" barDesign="subheader">
                                <div fd-bar-left>
                                    <fd-text [subline]="true" [text]="initialSuggestionEmptySubline()"></fd-text>
                                </div>
                            </div>
                        }
                    </div>
                }
                <ng-template [ngTemplateOutlet]="suggestionMenuTemplate"></ng-template>
            </fd-busy-indicator>
        </fd-popover-body>
    </fd-popover>
</ng-template>
<ng-template #mobileTemplate>
    <ng-template [ngTemplateOutlet]="inputFieldTemplate"></ng-template>
</ng-template>
<ng-template #searchCategoryMenu>
    <button
        class="fdp-search-field__category-button fd-input-group__button fd-button fd-button--transparent fd-button--menu {{
            appearance?.categoryButtonClass
        }}"
        [fdpMenuTriggerFor]="categoryMenu"
    >
        @if (!hideCategoryLabel) {
            <span class="fdp-search-field__category-label">
                {{ _currentCategory?.label || categoryLabel }}
            </span>
        }
    </button>
    <fdp-menu #categoryMenu>
        @for (category of categories; track category) {
            <fdp-menu-item (itemSelect)="setCurrentCategory(category)">{{ category.label }} </fdp-menu-item>
        }
    </fdp-menu>
</ng-template>
<ng-template #searchCategorySelect>
    <fd-select
        #categorySelectComponent
        [placeholder]="categoryLabel"
        [selectControlClass]="appearance?.categoryButtonClass"
        [selectDropdownButtonClass]="appearance?.categoryDropdownButtonClass"
        (valueChange)="setCurrentCategory($event)"
    >
        @for (category of categories; track category) {
            <li fd-option [value]="category">{{ category.label }}</li>
        }
    </fd-select>
</ng-template>
<ng-template #inputFieldTemplate>
    <div
        class="fdp-search-field"
        [class.with-categories]="_showCategoryDropdown"
        [class.is-loading]="isLoading"
        [class.is-compact]="contentDensityObserver.isCompactSignal()"
        [class.hide-category-label]="hideCategoryLabel"
    >
        <div
            #inputGroup
            class="fdp-search-field__input-group fd-input-group {{ appearance?.searchClass }}"
            [class.is-focus]="_isFocused"
        >
            @if (showAdvancedFilter()) {
                <span class="fd-input-group__addon fd-input-group__addon--button {{ appearance?.searchCategoryClass }}">
                    <button
                        (fdkClicked)="_advancedFilterButtonClicked()"
                        class="fdp-search-field__category-button fdp-search-field__advanced-filter-button fd-input-group__button fd-button fd-button--transparent fd-button--menu {{
                            appearance?.categoryButtonClass
                        }}"
                    >
                        <fd-icon glyph="filter"></fd-icon>
                    </button>
                </span>
            } @else if (_showCategoryDropdown) {
                <span class="fd-input-group__addon fd-input-group__addon--button {{ appearance?.searchCategoryClass }}">
                    <ng-template
                        [ngTemplateOutlet]="categoryMode === 'select' ? searchCategorySelect : searchCategoryMenu"
                    ></ng-template>
                </span>
            }
            <input
                #inputField
                fdkAutoComplete
                [options]="_autoCompleteSuggestions"
                [inputText]="inputText"
                (onComplete)="handleAutoComplete($event)"
                type="search"
                (focus)="_inputFocus()"
                (blur)="_isFocused = false; (null)"
                [attr.placeholder]="placeholder"
                class="fdp-search-field__input fd-input fd-input-group__input {{ appearance?.searchFieldClass }}"
                [attr.id]="_inputId"
                [attr.disabled]="disabled ? '' : null"
                [attr.title]="ariaLabel || ('platformSearchField.searchInputLabel' | fdTranslate)"
                [attr.aria-label]="ariaLabel || ('platformSearchField.searchInputLabel' | fdTranslate)"
                [attr.aria-labelledby]="ariaLabel ? null : ariaLabelledBy"
                [attr.aria-controls]="!!_menuId ? _menuId : null"
                [attr.aria-expanded]="(_dropdownValues$ | async)?.length !== 0 ? (_isOpen$() ? 'true' : 'false') : null"
                [attr.aria-haspopup]="(_dropdownValues$ | async)?.length !== 0"
                autocomplete="off"
                (keydown)="onKeydown($event)"
                (keydown.enter)="onSearchSubmit($event)"
                [(ngModel)]="inputText"
                (ngModelChange)="onValueChange($event)"
                (click)="mobile && openMobileMode()"
            />
            @if (inputText && inputText.length > 0) {
                <span class="fd-input-group__addon fd-input-group__addon--button {{ appearance?.addonClass }}">
                    <button
                        tabindex="-1"
                        [attr.aria-hidden]="!mobile"
                        [attr.title]="'platformSearchField.clearButtonTitle' | fdTranslate"
                        [attr.aria-label]="'platformSearchField.clearButtonTitle' | fdTranslate"
                        class="fdp-search-field__clear fd-button fd-button--transparent {{ appearance?.buttonClass }}"
                        [class.fd-input-group__button]="!appearance?.removeGroupButtonClass"
                        [attr.disabled]="disabled ? '' : null"
                        [attr.id]="_clearId"
                        (click)="clearTextInput()"
                    >
                        <fd-icon glyph="decline"></fd-icon>
                    </button>
                </span>
            } @else {
                <!-- prevents width of search from changing when there is no text in the input -->
                <span class="fd-input-group__addon fd-input-group__addon--button {{ appearance?.addonClass }}"></span>
            }
            @if (forceSearchButton || isLoading || (!isLoading && !_isSearchDone)) {
                <span
                    class="fd-input-group__addon fd-input-group__addon--button {{ appearance?.addonClass }} {{
                        appearance?.searchSubmitClass
                    }}"
                >
                    @if (!disableSearch) {
                        <button
                            tabindex="-1"
                            [attr.aria-hidden]="!mobile"
                            [attr.title]="'platformSearchField.submitButtonTitle' | fdTranslate"
                            [attr.aria-label]="'platformSearchField.submitButtonTitle' | fdTranslate"
                            class="fdp-search-field__submit fd-button fd-button--transparent {{
                                appearance?.buttonClass
                            }}"
                            [class.fd-input-group__button]="!appearance?.removeGroupButtonClass"
                            [attr.id]="_submitId"
                            [attr.disabled]="disabled ? '' : null"
                            (click)="onSearchSubmit()"
                        >
                            <fd-icon glyph="search"></fd-icon>
                        </button>
                    }
                </span>
            }
            @if (!disableRefresh && !isLoading && (_isRefresh || _isSearchDone)) {
                <span
                    class="fd-input-group__addon fd-input-group__addon--button {{ appearance?.addonClass }} {{
                        appearance?.searchSubmitClass
                    }}"
                >
                    <button
                        [attr.aria-title]="'platformSearchField.synchronizeButtonTitle' | fdTranslate"
                        [attr.aria-label]="'platformSearchField.synchronizeButtonTitle' | fdTranslate"
                        class="fdp-search-field__loading fd-input-group__button fd-button fd-button--transparent {{
                            appearance?.buttonClass
                        }}"
                        [attr.disabled]="disabled ? '' : null"
                        [attr.id]="_refreshId"
                        (click)="onSearchSubmit()"
                    >
                        <fd-icon glyph="synchronize"></fd-icon>
                    </button>
                </span>
            }
            @if (appearance?.helperClass) {
                <div [ngClass]="appearance?.helperClass"></div>
            }
        </div>
    </div>
</ng-template>
<ng-template #suggestionMenuTemplate>
    @if (_dropdownValues$ | async | suggestionMatches: inputText; as suggestionsFiltered) {
        @if (suggestionsFiltered?.length && !_onlyHeadersFiltered(suggestionsFiltered)) {
            <ul fd-list [searchResultsList]="true" (keydown)="onKeydown($event)">
                @for (filteredSuggestion of suggestionsFiltered; track filteredSuggestion) {
                    @if (filteredSuggestion?.isGroupHeader) {
                        <li fd-list-group-header class="fd-suggestion-header">
                            <span fd-list-title>{{ filteredSuggestion?.value }}</span>
                        </li>
                        @for (childSuggestion of filteredSuggestion?.children; track childSuggestion) {
                            <ng-template
                                [ngTemplateOutlet]="suggestionItemTemplate"
                                [ngTemplateOutletContext]="{ filteredSuggestion: childSuggestion }"
                            ></ng-template>
                        }
                        @if (filteredSuggestion?.searchInScopeText) {
                            <ng-template
                                [ngTemplateOutlet]="suggestionItemTemplate"
                                [ngTemplateOutletContext]="{ filteredSuggestion: filteredSuggestion }"
                            ></ng-template>
                        }
                    } @else {
                        <ng-template
                            [ngTemplateOutlet]="suggestionItemTemplate"
                            [ngTemplateOutletContext]="{ filteredSuggestion: filteredSuggestion }"
                        ></ng-template>
                    }
                }
            </ul>
            @if (suggestionFooter() && (_dropdownValues$ | async | suggestionMatches: inputText).length > 0) {
                <div fd-popover-body-footer class="fdp-search-field__footer">
                    <div fd-bar barDesign="footer">
                        <ng-template [ngTemplateOutlet]="suggestionFooter()"></ng-template>
                    </div>
                </div>
            }
        } @else if (searchResultsEmptyTemplate()) {
            <ng-template [ngTemplateOutlet]="searchResultsEmptyTemplate()"></ng-template>
        }
    }
</ng-template>

<ng-template #suggestionItemTemplate let-filteredSuggestion="filteredSuggestion">
    @let subline = filteredSuggestion?.data?.subline;
    @if (!filteredSuggestion.data || !filteredSuggestion.data.hideChild) {
        <li
            fd-list-item
            [interactive]="true"
            [suggestion]="true"
            fdpSearchFieldSuggestion
            (keydown.enter)="onItemClick(filteredSuggestion); $event.preventDefault()"
            (keyup.space)="onItemClick(filteredSuggestion); $event.stopPropagation()"
            (click)="onItemClick(filteredSuggestion)"
            [byline]="!!subline"
            #suggestionListItem
            (mouseenter)="_searchResultIsHoveredOrFocusedOrMobile(suggestionListItem)"
            (mouseleave)="_searchResultIsHoveredOrFocusedOrMobile(suggestionListItem)"
            [selected]="enableSelection() && filteredSuggestion === _selectedSuggestionItem"
            [counter]="filteredSuggestion.searchInScopeCounter"
        >
            @let listIconGlyph = filteredSuggestion?.data?.listIconGlyph;
            @if (listIconGlyph) {
                <span fd-list-thumbnail>
                    <i fd-list-icon [glyph]="listIconGlyph"></i>
                </span>
            }
            @let avatarGlyph = filteredSuggestion?.data?.avatarGlyph;
            @let avatarImage = filteredSuggestion?.data?.avatarImage;
            @let avatarLabel = filteredSuggestion?.data?.avatarLabel;
            @if (avatarGlyph || avatarImage || avatarLabel) {
                <fd-avatar
                    [circle]="true"
                    size="xs"
                    [glyph]="avatarGlyph"
                    [image]="avatarImage"
                    [label]="avatarLabel"
                ></fd-avatar>
            }
            @let prefix = filteredSuggestion?.data?.prefix;
            @if (prefix) {
                <fd-info-label fd-list-info-label [label]="prefix" color="10"></fd-info-label>
            }
            <!-- previous API was built on suggestions only being strings, hence the need for the check. -->
            @if (_isString(filteredSuggestion)) {
                <!-- toString() below is for type safety -->
                <span
                    fd-list-title
                    [innerHTML]="filteredSuggestion?.toString() | highlight: inputText : true : true"
                ></span>
            } @else {
                @if (subline) {
                    <div fd-list-content>
                        <span
                            fd-list-title
                            [innerHTML]="filteredSuggestion?.value | highlight: inputText : true : true"
                        ></span>
                        <span fd-list-subline>
                            {{ subline }}
                        </span>
                    </div>
                } @else {
                    @if (filteredSuggestion.searchInScopeText) {
                        <span fd-list-title>{{ filteredSuggestion.searchInScopeText }}</span>
                    } @else {
                        <span
                            fd-list-title
                            [innerHTML]="filteredSuggestion?.value | highlight: inputText : true : true"
                        ></span>
                    }
                }

                @let actionButtons = filteredSuggestion?.data?.actionButtons;
                @if (actionButtons && actionButtons.length) {
                    @for (button of actionButtons; track $index) {
                        @if (button.id) {
                            <button
                                fd-button
                                fdType="transparent"
                                [title]="button.actionButtonLabel"
                                [attr.aria-label]="button.actionButtonLabel"
                                [id]="button.actionButtonId"
                                [glyph]="button.actionButtonGlyph"
                                (fdkClicked)="_performButtonClick($event, button.actionButtonCallback)"
                            ></button>
                        } @else {
                            <button
                                fd-button
                                fdType="transparent"
                                [title]="button.actionButtonLabel"
                                [attr.aria-label]="button.actionButtonLabel"
                                [glyph]="button.actionButtonGlyph"
                                (fdkClicked)="_performButtonClick($event, button.actionButtonCallback)"
                            ></button>
                        }
                    }
                }

                @let showDeleteButton = filteredSuggestion?.data?.showDeleteButton;
                @let deleteCallback = filteredSuggestion?.data?.deleteCallback;
                @if (showDeleteButton && _searchResultIsHoveredOrFocusedOrMobile(suggestionListItem)) {
                    <button
                        fd-button
                        fdType="transparent"
                        title="('platformSearchField.deleteButtonLabel' | fdTranslate)"
                        glyph="decline"
                        (fdkClicked)="_performButtonClick($event, deleteCallback)"
                    ></button>
                }
            }
        </li>
    }
</ng-template>
