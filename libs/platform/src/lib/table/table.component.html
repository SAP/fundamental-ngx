<!-- Toolbar -->
<ng-container
    *ngIf="tableToolbar"
    [ngTemplateOutlet]="tableToolbar.contentTemplateRef"
    [ngTemplateOutletContext]="_toolbarContext"
></ng-container>

<fd-busy-indicator
    [loading]="(_tableService.tableLoading$ | async) === true && _dataSourceDirective._firstLoadingDone"
    [block]="true"
>
    <!-- Table Container -->
    <div class="fdp-table__container" #tableContainer>
        <ng-container [ngTemplateOutlet]="tableTemplate"></ng-container>

        <!-- Table column resizer for visually representing the resizing process -->
        <fdp-table-column-resizer *ngIf="enableDragResize" class="fdp-table__column-resizer"></fdp-table-column-resizer>
    </div>
</fd-busy-indicator>

<!-- Table Template -->
<ng-template #tableTemplate>
    <div
        class="fdp-table__body fd-scrollbar"
        [class.fdp-table__body--virtual-scroll]="!!_virtualScrollDirective?.virtualScroll"
        fdpTableScrollable
        #tableScrollable="tableScrollable"
        [style.height]="bodyHeight"
        [class.fixed-height]="!!bodyHeight"
        [attr.role]="pageScrolling ? 'feed' : null"
        [class.fd-table--fixed]="_freezableColumns.size || fixed"
    >
        <table
            fd-table
            [attr.role]="isTreeTable ? 'treegrid' : 'grid'"
            class="fdp-table__body-table"
            [allCellsFocusable]="true"
            [popIn]="_poppingColumns.length > 0"
            [class.fd-table--no-outer-border]="noOuterBorders"
        >
            <thead fd-table-header class="fdp-table__header">
                <tr
                    fd-table-row
                    fdp-table-header-row
                    [id]="id"
                    [fixed]="fixed"
                    [isShownSelectionColumn]="_isShownSelectionColumn"
                    [checkedState]="_checkedState"
                    [cellMockVisible]="_cellMockVisible"
                    [selectionMode]="_selectionMode"
                    [selectionColumnWidth]="_selectionColumnWidth"
                    [freezeColumnsTo]="freezeColumnsTo"
                    [freezeEndColumnsTo]="freezeEndColumnsTo"
                    [freezableColumns]="_freezableColumns"
                    [freezableEndColumns]="_freezableEndColumns"
                ></tr>
            </thead>

            <tbody
                *ngIf="!!this._tableRowsVisible.length; else emptyTableTemplate"
                fd-table-body
                fdkDndList
                [dragoverPredicate]="_dndTableDirective?.dragoverPredicate"
                [dropPredicate]="_dndTableDirective?.dropPredicate"
                [noBorderX]="noBorderX || noBorders"
                [noBorderY]="noBorderY || noBorders"
                [tabIndex]="pageScrolling ? 0 : -1"
                [items]="_tableRows"
                [draggable]="isDraggable"
                [dropMode]="_dndTableDirective?.dropMode ?? 'group'"
                [style.transform]="_virtualScrollDirective?.virtualScrollTransform"
                (itemDropped)="_dndTableDirective?.dragDropItemDrop($event)"
                (dropPredicateCalculating)="_calculatingLoading($event)"
            >
                <ng-container
                    *ngFor="let row of _tableRowsInViewport$ | async; let rowIdx = index; trackBy: _rowTrackBy"
                    [ngSwitch]="row.type"
                >
                    <tr
                        *ngSwitchCase="'group'"
                        fd-table-row
                        fdp-table-group-row
                        [index]="rowIdx"
                        [height]="rowHeight"
                        [draggable]="isDraggable"
                        [row]="row"
                        [id]="id"
                        [keyToColumnMap]="_keyToColumnMap"
                        [tableColumnsLength]="_tableColumnsLength"
                        (toggleGroupRow)="_toggleGroupRow($event)"
                        (click)="_emitRowActivate(row)"
                    ></tr>

                    <tr
                        *ngSwitchDefault
                        fd-table-row
                        [fdkDndItem]="row"
                        [applyDragItemClass]="isDraggable"
                        [class]="row | rowClasses : rowsClass"
                        [tabindex]="rowsActivable || !!row.navigatable ? 0 : -1"
                        [focusable]="rowsActivable || !!row.navigatable"
                        [hoverable]="rowsActivable || _isShownSelectionColumn || !!row.navigatable"
                        [activable]="rowsActivable || !!row.navigatable"
                        [active]="rowIdx === _navigatedRowIndex"
                        [highlightActive]="highlightNavigatedRow"
                        [style.height.px]="rowHeight"
                        [attr.aria-level]="isTreeTable ? row.level + 1 : null"
                        (fdkClicked)="_onRowClick(row, $event)"
                        (started)="_dndTableDirective?.dragDropStart()"
                        [main]="true"
                        [class.fd-table__row--draggable]="isDraggable"
                        fdp-table-row
                        [rowId]="id"
                        [index]="rowIdx"
                        [row]="row"
                        [cellMockVisible]="_cellMockVisible"
                        [selectionMode]="_selectionMode"
                        [selectableKey]="selectableKey"
                        [enableTristateMode]="enableTristateMode"
                        [fixed]="fixed"
                        [selectionColumnWidth]="_selectionColumnWidth"
                        [freezeColumnsTo]="freezeColumnsTo"
                        [freezeEndColumnsTo]="freezeEndColumnsTo"
                        [freezableColumns]="_freezableColumns"
                        [freezableEndColumns]="_freezableEndColumns"
                    ></tr>

                    <tr
                        *ngIf="row.type === 'item' && _poppingColumns.length > 0"
                        fd-table-row
                        fdp-table-popping-row
                        [secondary]="true"
                        [selectionMode]="selectionMode"
                        [row]="row"
                        [checked]="row.checked"
                        [class]="row | rowClasses : rowsClass"
                        (toggleGroupRow)="_toggleGroupRow($event)"
                        (cellClicked)="_onCellClick($event.index, $event.row)"
                    ></tr>
                </ng-container>
            </tbody>

            <!-- the tbody element below is so the scrollbar renders correctly -->
            <tbody
                *ngIf="_virtualScrollDirective?.virtualScroll"
                [style.height.px]="_virtualScrollDirective?.virtualScrollTotalHeight"
            ></tbody>
        </table>
    </div>
</ng-template>

<!-- Empty Table Message -->
<ng-template #emptyTableTemplate>
    <tbody *ngIf="!_dataSourceDirective._firstLoadingDone" fd-table-body>
        <tr fd-table-row *fdkRepeat="3">
            <td fd-table-cell *fdkRepeat="_tableColumnsLength">
                <fd-skeleton style="margin: auto 0" type="text" textLines="1" width="60%"></fd-skeleton>
            </td>
        </tr>
    </tbody>

    <tbody *ngIf="_dataSourceDirective._firstLoadingDone" fd-table-body class="fdp-table__empty">
        <tr fd-table-row>
            <td fd-table-cell class="fd-table__cell--no-data" [attr.colspan]="_tableColumnsLength">
                <div class="fdp-table__empty-table-message">
                    <ng-container>
                        <div #noDataWrapper>
                            <ng-content select="fdp-table-no-data-wrapper"></ng-content>
                        </div>
                        <div *ngIf="!noDataWrapper.hasChildNodes()">
                            {{ emptyTableMessage || ('platformTable.defaultEmptyMessage' | fdTranslate) }}
                        </div>
                    </ng-container>
                </div>
            </td>
        </tr>
    </tbody>
</ng-template>
