<ng-container *ngTemplateOutlet="defineTab"></ng-container>
<ng-template #defineTab>
    <fd-panel
        [expanded]="_definePanelState.included || _included.length === 0"
        *ngIf="_includeFilters.length"
    >
        <div fd-panel-title>
            <span i18n-label="@@platformI18nValueHelpDialog.Define.IncludeLabel">Include</span> ({{ _included.length }})
        </div>
        <div fd-panel-content>
            <ng-container
                [ngTemplateOutlet]="conditionContent"
                [ngTemplateOutletContext]="{ items: _included, type: _defineTypes.include, filters: _includeFilters, strategies: _includeStrategy }"
            ></ng-container>
            <fd-layout-grid class="condition-row" *ngIf="_included.length === 0">
                <div fdLayoutGridRow>
                    <div fdLayoutGridCol colGrow>&nbsp;</div>
                    <div fdLayoutGridCol class="action-col">
                        <button fd-button i18n-aria-label="@@platformI18nValueHelpDialog.AddDefineCondition" aria-label="Add new define condition" glyph="add" (click)="addNewIncluded()"></button>
                    </div>
                </div>
            </fd-layout-grid>
        </div>
    </fd-panel>
    <fd-panel
        [expanded]="_definePanelState.excluded"
        [fixed]="_excluded.length === 0"
        *ngIf="_excludeFilters.length"
    >
        <div fd-panel-title>
            <span i18n-label="@@platformI18nValueHelpDialog.Define.ExcludeLabel">Exclude</span> ({{ _excluded.length }})
        </div>
        <div fd-panel-content>
            <ng-container
                [ngTemplateOutlet]="conditionContent"
                [ngTemplateOutletContext]="{ items: _excluded, type: _defineTypes.exclude, filters: _excludeFilters, strategies: _excludeStrategy }"
            ></ng-container>

            <fd-layout-grid class="condition-row" *ngIf="_excluded.length === 0">
                <div fdLayoutGridRow>
                    <div fdLayoutGridCol colGrow>&nbsp;</div>
                    <div fdLayoutGridCol class="action-col">
                        <button fd-button i18n-aria-label="@@platformI18nValueHelpDialog.AddDefineCondition" aria-label="Add new define condition" glyph="add" (click)="addNewExcluded()"></button>
                    </div>
                </div>
            </fd-layout-grid>
        </div>
    </fd-panel>
</ng-template>


<ng-template #conditionContent let-items="items" let-type="type" let-filters="filters" let-strategies="strategies">
    <ng-container *ngFor="let item of items; trackBy: _trackByKeyAndType; index as i">
        <fd-layout-grid class="condition-row">
            <div fdLayoutGridCol="5">
                <div fdLayoutGridRow>
                    <fd-select
                        class="vhd-condition-filters"
                        fdLayoutGridCol
                        colGrow
                        i18n-placeholder="@@platformI18nValueHelpDialog.Define.IncludeFilterPlaceholder"
                        placeholder="Select a filter from data source"
                        [name]="uid + '-' + type + '-filter-' + item.id"
                        [(ngModel)]="item.key"
                        (ngModelChange)="_filterChanged()">
                        <fd-option value="*">{{ fullBodyLabel }}</fd-option>
                        <fd-option *ngFor="let filter of filters" [value]="filter.key">{{ filter.label }}</fd-option>
                    </fd-select>
                    <fd-select
                        class="vhd-condition-filters"
                        fdLayoutGridCol
                        colGrow
                        i18n-placeholder="@@platformI18nValueHelpDialog.Define.IncludeStrategyPlaceholder"
                        placeholder="Select a strategy"
                        [name]="uid + '-' + type + '-strategy-' + item.id"
                        [(ngModel)]="item.strategy"
                        (ngModelChange)="_filterChanged()">
                        <fd-option *ngFor="let strategy of strategies" [value]="strategy.key">
                            <span *ngIf="type === 'exclude'" i18n="@@platformI18nValueHelpDialog.Define.ExcludeStrategyPrefix">not</span>
                            {{ strategy.label }}
                        </fd-option>
                    </fd-select>
                </div>
            </div>
            <div fdLayoutGridCol colGrow>
                <div fdLayoutGridRow *ngIf="item.strategy !== _strategyValues.empty">
                    <ng-container *ngIf="item.strategy === _strategyValues.between; else valueIncludeTemplate">
                        <div fdLayoutGridCol colGrow>
                            <fd-form-input-message-group [triggers]="['focusin', 'focusout']">
                                <input
                                    fd-form-control
                                    type="text"
                                    i18n-placeholder="@@platformI18nValueHelpDialog.Define.FromPlaceholder"
                                    placeholder="From"
                                    [state]="item.value?.length > 7 ? 'error' : ''"
                                    [name]="uid + '-' + type + '-from-' + item.id"
                                    (blur)="_filterChanged()"
                                    [(ngModel)]="item.value" />
                                    <ng-container [ngTemplateOutlet]="countError" [ngTemplateOutletContext]="{ $implicit: item.value?.length }"></ng-container>
                            </fd-form-input-message-group>
                        </div>
                        <div fdLayoutGridCol colGrow>
                            <fd-form-input-message-group [triggers]="['focusin', 'focusout']">
                                <input
                                    fd-form-control
                                    type="text"
                                    i18n-placeholder="@@platformI18nValueHelpDialog.Define.ToPlaceholder"
                                    placeholder="To"
                                    [state]="item.valueTo?.length > 7 ? 'error' : ''"
                                    [name]="uid + '-' + type + '-to-' + item.id"
                                    (blur)="_filterChanged()"
                                    [(ngModel)]="item.valueTo" />
                                    <ng-container [ngTemplateOutlet]="countError" [ngTemplateOutletContext]="{ $implicit: item.valueTo?.length }"></ng-container>
                            </fd-form-input-message-group>
                        </div>
                    </ng-container>
                    <ng-template #valueIncludeTemplate>
                        <div fdLayoutGridCol colGrow>
                            <fd-form-input-message-group [triggers]="['focusin', 'focusout']">
                                <input
                                    fd-form-control
                                    type="text"
                                    i18n-placeholder="@@platformI18nValueHelpDialog.Define.ValuePlaceholder"
                                    placeholder="Value"
                                    [state]="item.value?.length > 7 ? 'error' : ''"
                                    [name]="uid + '-' + type + '-value-' + item.id"
                                    (blur)="_filterChanged()"
                                    [(ngModel)]="item.value" />
                                <ng-container [ngTemplateOutlet]="countError" [ngTemplateOutletContext]="{ $implicit: item.value?.length }"></ng-container>
                            </fd-form-input-message-group>
                        </div>
                    </ng-template>
                </div>
            </div>
            <div class="action-col" fdLayoutGridCol colGrow>
                <button
                    fd-button
                    i18n-aria-label="@@platformI18nValueHelpDialog.RemoveDefineCondition"
                    aria-label="Remove define condition"
                    glyph="decline"
                    (click)="removeItem(items, i)"></button>
            </div>
            <div class="action-col" fdLayoutGridCol colGrow>
                <button
                    fd-button
                    i18n-aria-label="@@platformI18nValueHelpDialog.AddDefineCondition"
                    aria-label="Add new define condition"
                    glyph="add"
                    [style.visibility]="i === items.length - 1 ? '' : 'hidden'"
                    (click)="addItem(type)"></button>
            </div>
        </fd-layout-grid>
    </ng-container>
</ng-template>


<ng-template #countError let-count>
    <fd-form-message type="error" *ngIf="count && count > 7">
        <span>Enter a value with no more than 7 characters</span>
    </fd-form-message>
</ng-template>
