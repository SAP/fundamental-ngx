<div class="approval-flow__messages" *ngIf="_messages.length">
    <fd-message-strip
        *ngFor="let message of _messages; let i = index; trackBy: _trackByFn"
        type="success"
        (onDismiss)="_dismissMessage(i)">
        <bdi>
            <span [ngSwitch]="message.type">
                <ng-container *ngSwitchCase="'approverAddSuccess'" [ngTemplateOutlet]="approverAddSuccess"></ng-container>
                <ng-container *ngSwitchCase="'teamAddSuccess'" [ngTemplateOutlet]="teamAddSuccess"></ng-container>
                <ng-container *ngSwitchCase="'nodeEdit'" [ngTemplateOutlet]="nodeEdit"></ng-container>
                <ng-container *ngSwitchCase="'nodeRemove'" [ngTemplateOutlet]="nodeRemove"></ng-container>
                <ng-container *ngSwitchCase="'nodesRemove'" [ngTemplateOutlet]="nodesRemove"></ng-container>
                <ng-container *ngSwitchCase="'teamRemove'" [ngTemplateOutlet]="teamRemove"></ng-container>
            </span>
            <a href="#" (click)="$event.preventDefault();_dismissMessage(i);_undoLastAction()" i18n="@@platformApprovalFlowUndo">Undo</a>
        </bdi>
    </fd-message-strip>
</div>

<fd-toolbar [hasTitle]="true" [attr.dir]="_dir">
    <h3 class="approval-flow__title">{{ title }}</h3>

    <div class="approval-flow__toolbar-controls" *ngIf="isEditAvailable">
        <button *ngIf="!_graph.length" fd-button label="Add a step" [compact]="true" (click)="_addNodeFromToolbar('empty')"></button>
        
        <button *ngIf="!_isEditMode && _graph.length" fd-button label="Edit" [compact]="true" (click)="_enterEditMode()"></button>

        <ng-container *ngIf="_isEditMode">
            <button *ngIf="_canAddBefore" fd-button label="Add approvers before" [compact]="true" (click)="_addNodeFromToolbar('before')"></button>

            <button *ngIf="_canAddAfter" fd-button label="Add approvers after" [compact]="true" (click)="_addNodeFromToolbar('after')"></button>
            
            <button *ngIf="_canAddParallel" fd-button label="Add parallel approvers" [compact]="true" (click)="_addNodeFromToolbar('parallel')"></button>

            <button *ngIf="_selectedNodes.length" fd-button label="Remove" [compact]="true" (click)="_deleteCheckedNodes()"></button>
        </ng-container>
    </div>
</fd-toolbar>

<div class="approval-flow__watchers" [attr.dir]="_dir" *ngIf="_approvalProcess?.watchers.length || _isEditMode">
    <p class="approval-flow__watchers-title" i18n="@@platformApprovalFlowWatchers">{{ watchersLabel }}</p>
    <ng-container *ngIf="!_isEditMode">
        <fd-avatar
            *ngFor="let watcher of _approvalProcess?.watchers; trackBy: _trackByFn"
            tabindex="0"
            size="xs"
            [image]="watcher.imgUrl"
            [label]="watcher.name"
            [circle]="true"
            (keyup.enter)="$event.stopPropagation(); _onWatcherClick(watcher)"
            (click)="_onWatcherClick(watcher)"></fd-avatar>
    </ng-container>
    <div class="approval-flow__watchers-input-container" *ngIf="_isEditMode">
        <fd-multi-input
            [compact]="true"
            [dropdownValues]="_usersForWatchersList"
            i18n-placeholder
            placeholder="Search here..."
            [displayFn]="_displayUserFn"
            [showAllButton]="true"
            [(ngModel)]="_selectedWatchers"
        ></fd-multi-input>
    </div>
</div>

<ng-container *ngIf="_graph.length; else emptyApprovalFlowGraph">
    <div
        class="approval-flow__container"
        [attr.dir]="_dir"
        [class.approval-flow__container--extra-padding-start]="_isCarousel && _carouselStep > 0"
        [class.approval-flow__container--extra-padding-end]="_isCarousel && (_maxCarouselStep - _carouselStep) > 0"
    >
        <div
            class="approval-flow__carousel-controls"
            *ngIf="_isCarousel"
            [attr.dir]="_dir"
            [class.approval-flow__carousel-controls--edit-mode]="_isEditMode"
        >
            <button class="approval-flow__control--prev-slide" *ngIf="_carouselStep > 0" (click)="previousSlide()"
                aria-label="Go to previous slide" i18n-aria-label="@@platformApprovalPrevButton">
                <fd-icon [glyph]="'navigation-' + (_isRTL ? 'right' : 'left') + '-arrow'"></fd-icon>
                {{ _carouselStep }}
            </button>

            <button class="approval-flow__control--next-slide" *ngIf="(_maxCarouselStep - _carouselStep) > 0"
                (click)="nextSlide()" aria-label="Go to next slide" i18n-aria-label="@@platformApprovalNextButton">
                {{ _maxCarouselStep - _carouselStep }}
                <fd-icon [glyph]="'navigation-' + (_isRTL ? 'left' : 'right') + '-arrow'"></fd-icon>
            </button>
        </div>

        <div class="approval-flow__graph-container" #graphContainerEl>
            <div
                class="approval-flow__graph" #graphEl [style.left.px]="_isRTL ? -_carouselScrollX : _carouselScrollX"
                [attr.dir]="_dir"
                [class.approval-flow__graph--edit-mode]="_isEditMode"
            >
                <div
                    class="approval-flow__column"
                    *ngFor="let column of _graph; let columnIndex = index; let firstColumn = first; let lastColumn = last; trackBy: _trackByFn"
                >
                    <ng-container
                        *ngFor="let node of column.nodes; let nodeIndex = index; let firstNode = first; let lastNode = last; trackBy: _trackByFn">
                        <fdp-approval-flow-node
                            cdkDrag
                            [cdkDragDisabled]="!_isEditMode || node.blank || node.space || node.status !== 'not started'"
                            [attr.dir]="_dir"
                            [attr.tabindex]="node.blank || node.space ? -1 : 0"
                            [node]="node"
                            [meta]="_graphMetadata[node.id]"
                            [isEdit]="_isEditMode"
                            [isNextNodeBlank]="!node.blank && _graph[columnIndex + 1]?.nodes[nodeIndex]?.blank"
                            [checkDueDate]="checkDueDate"
                            [dueDateThreshold]="dueDateThreshold"
                            [renderArrow]="columnIndex > 0"
                            [allNodesInColumnApproved]="column.allNodesApproved"
                            (onNodeClick)="_onNodeClick(node)"
                            (onNodeCheck)="_onNodeCheck(node)"
                            (onAdd)="_addNode(node, $event)"
                            (onEdit)="_editNode(node)"
                            (onDelete)="_onNodeDelete(node)"
                            (keyup.enter)="_onNodeClick(node)"
                            (keydown)="_onNodeKeyDown($event, node, firstColumn, firstNode, lastColumn, lastNode)"
                            (cdkDragReleased)="_onNodeDrop(node, $event.source)"
                            (cdkDragMoved)="_onNodeDragMoved(node)"
                        ></fdp-approval-flow-node>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</ng-container>

<div class="approval-flow__edit-mode-footer" [attr.dir]="_dir" *ngIf="_isEditMode">
    <button fd-button label="Save" [compact]="true" fdType="emphasized" (click)="_saveEditModeChanges()"></button>
    <button fd-button label="Exit" [compact]="true" fdType="transparent" (click)="_exitEditMode()"></button>
</div>

<ng-template let-messageToast #reminderTemplate>
    <ng-container
        *ngIf="messageToast.data.targets.length === 1; else multipleRecievers"
        i18n="@@platformApprovalFlowReminderMessage">
        Reminder has been sent to {{messageToast.data.targets[0].name}}
    </ng-container>
    
    <ng-template #multipleRecievers i18n="@@platformApprovalFlowReminderMessageMultipleRecievers">
        Reminder has been sent to {{messageToast.data.targets.length}} members of {{messageToast.data.node.description}}
    </ng-template>
</ng-template>

<ng-template #approverAddSuccess>
    <ng-container i18n="@@platformApprovalFlowApproverAddedAlert">
        1 approver has been added
    </ng-container>
</ng-template>
<ng-template #teamAddSuccess>
    <ng-container i18n="@@platformApprovalFlowTeamAddedAlert">
        1 team has been added
    </ng-container>
</ng-template>
<ng-template #nodeEdit>
    <ng-container i18n="@@platformApprovalFlowNodeEditedAlert">
        1 approver has been edited
    </ng-container>
</ng-template>
<ng-template #nodeRemove>
    <ng-container i18n="@@platformApprovalFlowNodeRemovedAlert">
        1 approver has been removed
    </ng-container>
</ng-template>
<ng-template #nodesRemove>
    <ng-container i18n="@@platformApprovalFlowNodesRemovedAlert">
        Approvers has been removed
    </ng-container>
</ng-template>
<ng-template #teamRemove>
    <ng-container i18n="@@platformApprovalFlowTeamRemovedAlert">
        1 team has been removed
    </ng-container>
</ng-template>

<ng-template #emptyApprovalFlowGraph>
    <figure fd-illustrated-message type="spot" [svgConfig]="_emptyApprovalFlowSpotConfig">
        <figcaption fd-illustrated-message-figcaption>
            <h3 fd-illustrated-message-title i18n="@@platformApprovalFlowEmptyTitle">
                Start adding approvers and watchers
            </h3>
            <p fd-illustrated-message-text i18n="@@platformApprovalFlowEmptyHint">
                To add approvers click <b>Add a step</b>. To add watchers, click the Watchers field.
            </p>
        </figcaption>
    </figure>
</ng-template>