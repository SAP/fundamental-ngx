<!-- Toolbar -->
<ng-container
    *ngIf="tableToolbar"
    [ngTemplateOutlet]="tableToolbar.contentTemplateRef"
    [ngTemplateOutletContext]="_toolbarContext"
></ng-container>

<fd-busy-indicator
    [loading]="loading"
    block="true"
>
    <!-- Table Container -->
    <div
        #tableContainer
        role="grid"
        class="fdp-table__container"
        [attr.aria-labelledby]="_tableToolbarTitleId"
    >
        <!-- Table header outlet -->
        <ng-container [ngTemplateOutlet]="tableHeaderTemplate"></ng-container>

        <!-- Table body outlet -->
        <ng-container [ngTemplateOutlet]="tableBodyTemplate"></ng-container>

        <fdp-table-column-resizer [style.bottom.px]="_scrollBarWidth"></fdp-table-column-resizer>
    </div>

    <div #focusableMock tabindex="0" [style.display]="loading ? 'none' : 'block'"></div>
</fd-busy-indicator>

<!-- Table Header Template -->
<ng-template #tableHeaderTemplate>
    <div
        class="fdp-table__header"
        [style.padding-left.px]="_rtl ? _scrollBarWidth : 0"
        [style.padding-right.px]="_rtl ? 0 : _scrollBarWidth"
    >
        <div
            class="fd-table--fixed"
            [ngStyle]="_getFixedTableStyles()"
            fdpTableScroller="horizontal"
        >
            <table
                fd-table
                role="presentation"
                class="fdp-table__header-table"
            >
                <thead
                    fd-table-header
                    role="rowgroup"
                >
                    <ng-container [ngTemplateOutlet]="tableHeaderRowTemplate"></ng-container>
                </thead>
            </table>
        </div>

        <div
            class="fdp-table__scrollbar-mock"
            [style.width.px]="_scrollBarWidth"
        ></div>
    </div>
</ng-template>

<!-- Table Header Columns -->
<ng-template #tableHeaderRowTemplate>
    <tr
        fd-table-row
        role="row"
    >
        <th
            *ngIf="_isShownSelectionColumn"
            fd-table-cell
            role="columnheader"
            class="fd-table__cell--fixed fdp-table__cell--selection"
            aria-label="Select row"
            i18n-aria-label="@@platformTableSelectRow"
            [focusable]="true"
            [fd-table-cell-selectable]="_firstCellNavigationId"
            [class.fd-table__cell--checkbox]="selectionMode === SELECTION_MODE.MULTIPLE"
            (keydown.enter)="_toggleAllSelectableRows()"
            (keydown.space)="_toggleAllSelectableRows($event)"
        >
            <fd-checkbox
                *ngIf="selectionMode === SELECTION_MODE.MULTIPLE; else emptyTHTemplate"
                [compact]="contentDensity !== CONTENT_DENSITY.COZY"
                [ngModel]="_checkedAll"
                aria-label="Toggle selection for all rows"
                i18n-aria-label="@@platformTableSelectAllRows"
                (ngModelChange)="_toggleAllSelectableRows()"
            ></fd-checkbox>
        </th>

        <ng-container *ngFor="let column of _visibleColumns; let colIdx = index">
            <th
                fd-table-cell
                role="columnheader"
                [id]="id + '__' + column.name"
                [focusable]="true"
                [fd-table-cell-selectable]="_getCellNavigationId(0, colIdx)"
                [fdp-table-cell-resizable]="_getColumnResizableSide(colIdx)"
                [columnName]="column.name"
                [attr.aria-colindex]="colIdx"
                [class.fd-table__cell--fixed]="_freezableColumns?.includes(column.name)"
                [class.fd-table__cell--fixed-last]="column.name === freezeColumnsTo"
                [class.fdp-table__cell--has-menu]="_isColumnHasHeaderMenu(column)"
                [ngStyle]="_getCellStyles(column)"
                [style.text-align]="column.align"
                [fdPopoverTrigger]="columnHeaderPopover"
            >
                <div class="fd-table__text fd-table__text--no-wrap" [class.fd-table__inner]="_sortRulesMap.has(column.key)">
                    <ng-container *ngTemplateOutlet="tableHeaderCellContentTemplate; context:{column: column}">
                    </ng-container>

                    <fd-icon
                        *ngIf="_sortRulesMap.has(column.key)"
                        fd-table-icon
                        [glyph]="_sortRulesMap.get(column.key).direction === SORT_DIRECTION.ASC ? 'sort-ascending' : 'sort-descending'"
                    ></fd-icon>
                </div>

                <!-- Header menu -->
                <fd-popover
                    #columnHeaderPopover
                    [disabled]="!_isColumnHasHeaderMenu(column)"
                    [noArrow]="true"
                    fd-table-popover
                >
                    <ul
                        fd-list
                        [noBorder]="true"
                        [compact]="true"
                    >
                        <!-- Sorting -->
                        <ng-container *ngIf="column.sortable">
                            <li
                                class="fdp-table__item--clickable"
                                fd-list-item
                                (click)="_columnHeaderSortBy(column.key, SORT_DIRECTION.ASC)"
                                (keyup.enter)="_columnHeaderSortBy(column.key, SORT_DIRECTION.ASC)"
                            >
                                <span
                                    fd-list-icon
                                    glyph="sort-ascending"
                                ></span>
                                <span
                                    fd-list-title
                                    i18n="@@platformTableHeaderMenuSortAsc"
                                >Sort Ascending</span>
                            </li>
                            <li
                                class="fdp-table__item--clickable"
                                fd-list-item
                                (click)="_columnHeaderSortBy(column.key, SORT_DIRECTION.DESC)"
                                (keyup.enter)="_columnHeaderSortBy(column.key, SORT_DIRECTION.DESC)"
                            >
                                <span
                                    fd-list-icon
                                    glyph="sort-descending"
                                ></span>
                                <span
                                    fd-list-title
                                    i18n="@@platformTableHeaderMenuSortDesc"
                                >Sort Descending</span>
                            </li>
                        </ng-container>

                        <!-- Grouping -->
                        <ng-container *ngIf="column.groupable">
                            <li
                                class="fdp-table__item--clickable"
                                fd-list-item
                                (click)="_columnHeaderGroupBy(column.key)"
                                (keyup.enter)="_columnHeaderGroupBy(column.key)"
                            >
                                <span fd-list-icon></span>
                                <span
                                    fd-list-title
                                    i18n="@@platformTableHeaderMenuGroup"
                                >Group</span>
                            </li>
                        </ng-container>

                        <!-- Freeze -->
                        <ng-container *ngIf="column.freezable">
                            <li
                                *ngIf="!_freezableColumns?.includes(column.name)"
                                class="fdp-table__item--clickable"
                                fd-list-item
                                (click)="freezeToColumn(column.name)"
                                (keyup.enter)="freezeToColumn(column.name)"
                            >
                                <span></span>
                                <span
                                    fd-list-title
                                    i18n="@@platformTableHeaderMenuFreeze"
                                >Freeze</span>
                            </li>
                            <li
                                *ngIf="_freezableColumns?.includes(column.name)"
                                class="fdp-table__item--clickable"
                                fd-list-item
                                (click)="unfreeze(column.name)"
                                (keyup.enter)="unfreeze(column.name)"
                            >
                                <span></span>
                                <span
                                    fd-list-title
                                    i18n="@@platformTableHeaderMenuUnfreeze"
                                >Unfreeze</span>
                            </li>
                        </ng-container>

                        <!-- Filtering -->
                        <ng-container *ngIf="column.filterable && !_isFilteringFromHeaderDisabled">
                            <li fd-list-item>
                                <i
                                    fd-list-icon
                                    glyph="filter"
                                ></i>
                                <div
                                    fd-form-item
                                    [horizontal]="true"
                                    (click)="$event.stopPropagation()"
                                >
                                    <label
                                        fd-form-label
                                        [for]="'fdp-table-column-filtering-' + column.name"
                                        i18n="@@platformTableHeaderMenuFilter"
                                    >Filter</label>
                                    <input
                                        fd-form-control
                                        [compact]="true"
                                        [id]="'fdp-table-column-filtering-' + column.name"
                                        (keyup.enter)="_columnHeaderFilterBy(column.key, $event.target.value)"
                                    >
                                </div>
                            </li>
                        </ng-container>
                    </ul>
                </fd-popover>
            </th>
        </ng-container>

        <th class="fdp-table__cell--empty"></th>
    </tr>
</ng-template>

<!-- Column Header Cell Content Template  -->
<ng-template
    #tableHeaderCellContentTemplate
    let-column="column"
>
    <ng-container
        [ngIf]="column?.headerCellTemplate"
        *ngTemplateOutlet="column.headerCellTemplate"
    ></ng-container>

    <ng-container
        [ngIf]="!column?.headerCellTemplate"
        *ngTemplateOutlet="defaultTableHeaderCellTemplate; context: {column: column}"
    ></ng-container>
</ng-template>

<!-- Default Header Cell Content Template  -->
<ng-template #defaultTableHeaderCellTemplate let-column="column">
    <span class="fd-table__text fd-table__text--no-wrap">{{ column?.label }}</span>
</ng-template>

<!-- Table Body Template -->
<ng-template #tableBodyTemplate>
    <div
        class="fdp-table__body"
        fdpTableScrollable
        #verticalScrollable="tableScrollable"
        [style.height]="bodyHeight"
    >
        <div
            *ngIf="_tableRowsVisible.length || loading; else emptyTableTemplate"
            fdpTableScrollable
            fdpTableScroller="horizontal"
            class="fd-table--fixed"
            [ngStyle]="_getFixedTableStyles()"
        >
            <table
                fd-table
                role="presentation"
                class="fdp-table__body-table"
            >
                <tbody
                    fd-table-body
                    fd-dnd-list
                    role="rowgroup"
                    [noBorderX]="noBodyBorders"
                    [noBorderY]="noBodyBorders"
                    [items]="_tableRows"
                    [draggable]="_rowsDraggable"
                    [replaceMode]="true"
                    (itemDropped)="_dragDropItemDrop($event)"
                >
                    <ng-container
                        *ngFor="let row of _tableRowsVisible; let rowIdx = index;"
                        [ngSwitch]="row.type"
                    >
                        <ng-container
                            *ngSwitchCase="'group'"
                            [ngTemplateOutlet]="groupRowTemplate"
                            [ngTemplateOutletContext]="{row: row, rows: _tableRowsVisible, rowIdx: rowIdx}"
                        ></ng-container>

                        <!-- Item Row Template -->
                        <!-- Cannot be placed inside ng-template as it won't be visible for Drag&Drop directive through ContentChildren -->
                        <tr
                            *ngSwitchDefault
                            fd-table-row
                            fd-dnd-item
                            role="row"
                            tabindex="-1"
                            [class.fdp-table__row--tree]="_isTreeRow(row)"
                            [hoverable]="_isShownSelectionColumn || row.hasNavIndicator"
                            [navigatable]="row.navigatable || rowsActivable"
                            [activable]="row.hasNavIndicator || rowsActivable"
                            [attr.aria-selected]="row.checked"
                            [attr.aria-rowindex]="rowIdx"
                            (click)="_onRowClick(row)"
                            (started)="_dragDropStart()"
                        >
                            <td
                                *ngIf="_isShownSelectionColumn"
                                fd-table-cell
                                role="gridcell"
                                class="fd-table__cell--fixed fdp-table__cell--selection"
                                [fd-table-cell-selectable]="_getCellNavigationId(rowIdx + 1, -1)"
                                [focusable]="true"
                                [class.fd-table__cell--checkbox]="selectionMode === SELECTION_MODE.MULTIPLE"
                                (click)="_toggleSelectableRow(row)"
                                (keydown.enter)="_toggleSelectableRow(row)"
                                (keydown.space)="_toggleSelectableRow(row, $event)"
                            >

                                <fd-checkbox
                                    *ngIf="selectionMode === SELECTION_MODE.MULTIPLE"
                                    [compact]="contentDensity !== CONTENT_DENSITY.COZY"
                                    [ngModel]="row.checked"
                                    (ngModelChange)="_toggleSelectableRow(row)"
                                ></fd-checkbox>
                            </td>

                            <td
                                *ngFor="let column of _visibleColumns; let colIdx = index"
                                fd-table-cell
                                role="gridcell"
                                [focusable]="true"
                                [fd-table-cell-selectable]="_getCellNavigationId(rowIdx + 1, colIdx)"
                                [headers]="id + '__' + column.name"
                                [fdp-table-cell-resizable]="_getColumnResizableSide(colIdx)"
                                [columnName]="column.name"
                                [style.textAlign]="column.align"
                                [class.fd-table__cell--fixed]="_freezableColumns?.includes(column.name)"
                                [class.fd-table__cell--fixed-last]="column.name === freezeColumnsTo"
                                [class.fdp-table__cell--tree]="_isTreeRowFirstCell(colIdx, row)"
                                [class.fdp-table__cell--tree-no-expand]="colIdx === 0 && isTreeTable && _isItemRow(row)"
                                [ngStyle]="_getCellStyles(column)"
                                [attr.aria-expanded]="_isTreeRow(row) ? row.expanded : null"
                                [attr.data-nesting-level]="colIdx === 0 && row.level"
                                (click)="_isTreeRowFirstCell(colIdx, row) && _toggleGroupRow(row)"
                                (keydown.enter)="_isTreeRowFirstCell(colIdx, row) && _toggleGroupRow(row)"
                                (keydown.space)="_isTreeRowFirstCell(colIdx, row) && _toggleGroupRow(row, $event)"
                            >
                                <fd-icon
                                    *ngIf="_isTreeRowFirstCell(colIdx, row)"
                                    class="fdp-table__cell--expand"
                                    [glyph]="row.expanded ? 'navigation-down-arrow' : _rtl ? 'navigation-left-arrow' : 'navigation-right-arrow'"
                                    aria-hidden="true"
                                ></fd-icon>

                                <i
                                    *ngIf="_showNavIndicator(colIdx, row)"
                                    fd-table-icon
                                    [ngClass]="_rtl ? 'sap-icon--slim-arrow-left' : 'sap-icon--slim-arrow-right'"
                                    class="fdp-table__navigation-indicator"
                                ></i>

                                <button
                                    *ngIf="_showNavButton(colIdx, row)"
                                    class="fd-button fd-button--transparent"
                                    [disabled]="!row.navigatable"
                                    (click)="_navigateByRowNavigationTarget(row)"
                                    (keydown.enter)="_navigateByRowNavigationTarget(row)"
                                >
                                    <i [ngClass]="_rtl ? 'sap-icon--navigation-left-arrow' : 'sap-icon--navigation-right-arrow'"></i>
                                </button>

                                <ng-container *ngIf="column?.columnCellTemplate; else defaultTableCellTemplate">
                                    <ng-container *ngTemplateOutlet="column.columnCellTemplate; context:{$implicit: row.value}">
                                    </ng-container>
                                </ng-container>

                                <ng-template #defaultTableCellTemplate>
                                    <span class="fd-table__text fd-table__text--no-wrap">
                                        {{row?.value | valueByPath: column.key}}
                                    </span>
                                </ng-template>
                            </td>

                            <td class="fdp-table__cell--empty"></td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Table Body horizontal scroll area -->
    <div
        fdpTableScrollable
        fdpTableScroller="horizontal"
        class="fdp-table__body-hs"
        [class.fdp-table__body-hs--empty]="_scrollBarWidth === 0"
    >
        <div class="fdp-table__body-hs-spacer">
            <table
                *ngIf="_tableRowsVisible.length"
                fd-table
                role="presentation"
                class="fdp-table__body-hs-table"
            >
                <tbody fd-table-body>
                    <tr fd-table-row role="row">
                        <td
                            *ngIf="_isShownSelectionColumn"
                            fd-table-cell
                            role="gridcell"
                            class="fdp-table__cell--selection"
                        ></td>

                        <td
                            *ngFor="let column of _visibleColumns"
                            [ngStyle]="_getCellStyles(column)"
                            fd-table-cell
                            role="gridcell"
                        ></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</ng-template>

<!-- Group row Template -->
<ng-template
    #groupRowTemplate
    let-row="row"
    let-rowIdx="rowIdx"
>
    <tr
        role="row"
        fd-table-row
        class="fdp-table__row--group"
        [attr.aria-rowindex]="rowIdx"
        (click)="_emitRowActivate(row)"
    >
        <td
            fd-table-cell
            role="gridcell"
            class="fd-table__cell--fixed fdp-table__cell--group"
            [focusable]="true"
            [fd-table-cell-selectable]="_getCellNavigationId(rowIdx + 1, 0, true)"
            [attr.colspan]="_tableColumnsLength"
            [attr.aria-expanded]="row.expanded"
            [attr.data-nesting-level]="row.level"
            (click)="_toggleGroupRow(row)"
            (keydown.enter)="_toggleGroupRow(row)"
            (keydown.space)="_toggleGroupRow(row, $event)"
        >
            <fd-icon
                class="fdp-table__cell--expand"
                [glyph]="row.expanded ? 'navigation-down-arrow' : _rtl ? 'navigation-left-arrow' : 'navigation-right-arrow'"
            ></fd-icon>

            <!-- Group row template when no nested groups -->
            <ng-container *ngIf="_groupRulesMap.size == 1">
                {{ row.value?.value }} - {{ row.value?.count }}
            </ng-container>

            <!-- Group row template when there are nested groups -->
            <ng-container *ngIf="_groupRulesMap.size != 1">
                <ng-container
                    *ngTemplateOutlet="tableHeaderCellContentTemplate; context: { column: _keyToColumnMap.get(row.value?.field) }"
                ></ng-container>: {{ row.value?.value }}
            </ng-container>
        </td>
    </tr>
</ng-template>

<!-- Empty Table Message -->
<ng-template #emptyTableTemplate>
    <table fd-table class="fdp-table__empty-table">
        <tbody
            fd-table-body
            role="rowgroup"
        >
            <tr
                fd-table-row
                role="row"
            >
                <td
                    fd-table-cell
                    role="gridcell"
                    [attr.colspan]="_tableColumnsLength"
                >
                    <div class="fd-table__empty-table-message">
                        <div
                            i18n="@@platformTableEmptyMessage"
                            [innerText]="emptyTableMessage"
                        ></div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</ng-template>

<!-- Empty TH Message -->
<ng-template #emptyTHTemplate>&nbsp;</ng-template>
