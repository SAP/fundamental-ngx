<ng-container *ngTemplateOutlet="mobile ? selectMobileTemplate : selectDesktopTemplate"></ng-container>

<ng-template #selectDesktopTemplate>
    <fd-popover
        [(isOpen)]="isOpen"
        [triggers]="[]"
        [appendTo]="appendTo"
        [options]="popperOptions"
        [fillControlMode]="fillControlMode"
        [closeOnOutsideClick]="closeOnOutsideClick"
        [disabled]="disabled || loading || readonly"
        (isOpenChange)="isOpenChangeHandle($event)">

        <fd-popover-control>
            <ng-container *ngTemplateOutlet="selectInputControlTemplate"></ng-container>
        </fd-popover-control>

        <fd-popover-body [attr.aria-controls]="controlId"
                         [style.maxHeight]="maxHeight || calculatedMaxHeight + 'px'">
            <ng-container *ngTemplateOutlet="selectOptionsListTemplate"></ng-container>
        </fd-popover-body>
    </fd-popover>
</ng-template>

<ng-template #selectMobileTemplate>
    <ng-container *ngTemplateOutlet="selectInputControlTemplate"></ng-container>
</ng-template>

<ng-template #selectInputControlTemplate>
    <div class="fd-select"
         [class.fd-select--compact]="compact">
        <div class="fd-select__control"
             #selectControl
             [ngClass]="state ? 'is-' + state : ''"
             [class.is-disabled]="disabled"
             [class.is-readonly]="readonly"
             [attr.tabindex]="disabled ? -1 : 0"
             [attr.aria-expanded]="isOpen"
             [attr.aria-disabled]="disabled"
             [attr.aria-readonly]="readonly"
             [attr.aria-controls]="controlId"
             [attr.aria-haspopup]="!disabled && !readonly && !loading"
             (click)="toggle()">

            <div>
                <ng-container
                    [ngTemplateOutlet]="controlTemplate ? controlTemplate : defaultSelectContent"
                    [ngTemplateOutletContext]="{$implicit: selectValue, option: selected}">
                </ng-container>

                <ng-template #defaultSelectContent>
                    {{ selectValue }}
                </ng-template>
            </div>

            <button fd-button
                    tabindex="-1"
                    class="fd-button--transparent fd-select__button"
                    *ngIf="!readonly"
                    [disabled]="disabled || loading"
                    [glyph]="glyph">
            </button>
        </div>
    </div>

    <fd-busy-indicator *ngIf="loading" [loading]="true" size="m"></fd-busy-indicator>
</ng-template>

<ng-template #selectOptionsListTemplate>
    <ul fd-list
        [compact]="compact"
        [dropdownMode]="true"
        [hasMessage]="stateMessage">

        <li fd-list-message *ngIf="stateMessage" [type]="state">
            {{stateMessage}}
        </li>

        <ng-content></ng-content>

    </ul>
</ng-template>
